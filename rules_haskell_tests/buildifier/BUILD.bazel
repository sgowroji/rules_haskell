load("@com_github_bazelbuild_buildtools//buildifier:def.bzl", "buildifier", "buildifier_test")
load("@os_info//:os_info.bzl", "is_nixos")

# Buildifier does not work yet with bzlmod+nixos
# See https://github.com/bazelbuild/bazel-gazelle/issues/1469
manual_on_nixos = ["manual"] if is_nixos else []

# Run this to check for errors in BUILD files.
buildifier(
    name = "buildifier",
    mode = "check",
    tags = manual_on_nixos,
)

# Run this to fix the errors in BUILD files.
buildifier(
    name = "buildifier-fix",
    mode = "fix",
    tags = manual_on_nixos,
    verbose = True,
)

buildifier_test(
    name = "buildifier_test",
    srcs = [
        "//:BUILD.bazel",
        "//:WORKSPACE",
        "//:non_module_deps.bzl",
        "//:non_module_deps_1.bzl",
        "//:non_module_deps_2.bzl",
        "//buildifier:all_files",
        "//tests:all_files",
    ],
    mode = "diff",
    tags = ["dont_test_on_windows"] + manual_on_nixos,
)

filegroup(
    name = "all_files",
    testonly = True,
    srcs = glob(["**"]),
    visibility = ["//visibility:public"],
)
